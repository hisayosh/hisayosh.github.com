<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>新208.5日問題 - Systems with Intel® Xeon® Processor E5 hung after upgrade of Red Hat Enterprise Linux 6</title>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-37369984-2', 'hisayosh.github.io');
        ga('send', 'pageview');
    </script>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="新208.5日問題 - Systems with Intel® Xeon® Processor E5 hung after upgrade of Red Hat Enterprise Linux 6"/>
            <meta property="og:url" content="../../../../posts/2013/12/208days-problem/"/>
            <meta property="og:description" content="Linux の連続稼働時間が 208.5 日を過ぎた段階で突如 Kernel Panic を引き起こすという過激な挙動で2011年の年の瀬に話題となった "旧208.5日問題" ですが、あれから二年が経った今、Linux Kernel 内の bug と Intel Xeon CPU の bug の合わせ技により再度類似の不具合が発生することが分かっています。"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../../theme/css/bootstrap.min.css" type="text/css"/>
    <link href="../../../../theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../theme/css/bootstrap-glyphicons.css" rel="stylesheet">
    <link href="../../../../theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="//code.jquery.com/jquery.min.js"></script>

        <link href="../../../../feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="hisayosh->blog ATOM Feed"/>
        <link href="../../../../feeds/all.rss.xml" type="application/atom+xml" rel="alternate"
              title="hisayosh->blog RSS Feed"/>

</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../../../.." class="navbar-brand">hisayosh->blog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="../../../../category/linux.html">Linux</a>
                        </li>
                        <li >
                            <a href="../../../../category/identity.html">Identity</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="../../../../archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="../../../../posts/2013/12/208days-problem/"
                       rel="bookmark"
                       title="Permalink to 新208.5日問題 - Systems with Intel® Xeon® Processor E5 hung after upgrade of Red Hat Enterprise Linux 6">
                        新208.5日問題 - Systems with Intel® Xeon® Processor E5 hung after upgrade of Red Hat Enterprise Linux 6
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>Tue 24 December 2013
    </span>



<span class="label label-default">Tags</span>
	<a href="../../../../tag/linux.html">Linux</a>
        /
	<a href="../../../../tag/bug.html">Bug</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Linux の連続稼働時間が 208.5 日を過ぎた段階で突如 Kernel Panic を引き起こすという過激な挙動で2011年の年の瀬に話題となった "旧208.5日問題" ですが、あれから二年が経った今、Linux Kernel 内の bug と Intel Xeon CPU の bug の合わせ技により<strong>再度類似の不具合が発生することが分かっています。</strong></p>
<p>旧 208.5 日問題の発生原理に関しては以下の blog が参考になります。<br />
<a href="http://kenichiokuyama.blogspot.jp/2011/12/schedclock-overflow-after-2085-days-in.html">okkyの銀河制圧奇譚 : sched_clock() overflow after 208.5 days in Linux Kernel</a></p>
<h3><strong>影響範囲</strong></h3>
<hr />
<p>旧 208.5 日問題の対策パッチがあたっている Linux Kernel であっても、本 208.5 日問題は異なるロジックにより発生するため、<strong>影響を受けます。</strong></p>
<ul>
<li>Red Hat Enterprise Linux 6.2, 6.3, and 6.4 (kernel 2.6.32-220, 2.6.32-279, and 2.6.32-358 series)</li>
</ul>
<h3><strong>不具合発生条件</strong></h3>
<hr />
<ol>
<li>Intel Xeon E5 シリーズのプロセッサーを利用している</li>
<li>上記影響範囲に記述した Linux Kernel のうち、修正パッチが当たっていない（これらのバージョンのうち現在稼働中の RHEL 及び RHEL 系サーバはほとんどが該当すると思います。）</li>
<li>最後に cold reboot を行ってから 208.5 日以上の時間が経過している状態で、再起動を行う</li>
</ol>
<h3><strong>結論</strong></h3>
<hr />
<ol>
<li>不具合対象の環境は一時的な運用の見直しが必要です。サーバ再起動は cold reboot にしましょう</li>
<li>根本解決には、対策パッチをあてるか、kernel code を修正してリビルドしたものを組み込みましょう</li>
</ol>
<p>※ RHEL では kernel-2.6.32-220.45.1.el6 (6.2), kernel-2.6.32-279.37.2.el6 (6.3), kernel-2.6.32-358.23.2.el6 (6.4), kernel-2.6.32-431.el6 (6.5) で修正されているようです。</p>
<h3><strong>旧 208.5 日問題のおさらい</strong></h3>
<hr />
<p>旧 208.5 日問題は以下のインライン関数が原因となり発生します。CPU 内の TSC (Time Stamp Counter) の値を Linux が nano sec order の clock として利用するためのロジックです。CYCNS_SCALE_FACTOR は整数の 10 を表します。</p>
<p>linux-2.6.32-220(/arch/x86/include/asm/timer.h)</p>
<div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">__cycles_2_ns</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">cyc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ns</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cyc2ns_offset</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
    <span class="n">ns</span> <span class="o">+=</span> <span class="n">cyc</span> <span class="o">*</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">cyc2ns</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CYC2NS_SCALE_FACTOR</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>ご覧の通り、TSC の値を TSC * SC &gt;&gt; 10 することで 64 bit 変数に nano sec を代入しようとしているので、10 bit shift が行われる前の段階では pico sec order の演算を行うことになります。pico sec order の 1 秒を表現するためには、約 40 bit の空間が必要となります。変数が 64 bit であるため、 1 秒以上の表現のためには残り約 24 bit 程しかなく、208.5日問題における 208.5 日とは、この約 24 bit で表現できる日数の上限を表したものになっています。（この日数を超えると overflow が発生します。）</p>
<h3><strong>新 208.5 日問題の解説</strong></h3>
<hr />
<p>Linux Kernel を起動する際、各種初期化処理を行う start_kernel()内 で x86_late_time_init() という関数が呼び出されます。</p>
<p>linux-2.6.32.358(/arch/x86/kernel/time.c)</p>
<div class="highlight"><pre><span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">x86_late_time_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">timer_init</span><span class="p">();</span>
    <span class="n">tsc_init</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>このうち、tsc_init() の中で、cyc2ns_offset の初期化を行います。この初期化処理は、旧 208.5 日問題と同一のロジックを経由します。Linux の起動時には、 CPU の仕様として TSC がリセットされるはずであり、Linux 起動プロセスの初期段階である本関数がコールされる時点で TSC が 208.5 日に到達しているはずがなく、優先度の低い問題として扱われていたのだと思います。</p>
<p>linux-2.6.32-358(/arch/x86/kernel/tsc.c)</p>
<div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">set_cyc2ns_scale</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu_khz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">tsc_now</span><span class="p">,</span> <span class="n">ns_now</span><span class="p">,</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="o">*</span><span class="n">scale</span><span class="p">;</span>

    <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
    <span class="n">sched_clock_idle_sleep_event</span><span class="p">();</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cyc2ns</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cyc2ns_offset</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

    <span class="n">rdtscll</span><span class="p">(</span><span class="n">tsc_now</span><span class="p">);</span>
    <span class="n">ns_now</span> <span class="o">=</span> <span class="n">__cycles_2_ns</span><span class="p">(</span><span class="n">tsc_now</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cpu_khz</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSEC_PER_MSEC</span> <span class="o">&lt;&lt;</span> <span class="n">CYC2NS_SCALE_FACTOR</span><span class="p">)</span><span class="o">/</span><span class="n">cpu_khz</span><span class="p">;</span>
        <span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ns_now</span> <span class="o">-</span> <span class="p">(</span><span class="n">tsc_now</span> <span class="o">*</span> <span class="o">*</span><span class="n">scale</span> <span class="o">&gt;&gt;</span> <span class="n">CYC2NS_SCALE_FACTOR</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">sched_clock_idle_wakeup_event</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>しかし、時を同じくして、Intel Xeon Processor E5 Family は以下の不具合を抱えていました。本来リセットされるはずの TSC の値が、 Warm Reset (通常の再起動)時に初期化されないという不具合です。サーバの電源断を経由しない限り、 E5 Family Processor の TSC の値は保持され続けます。</p>
<blockquote>
<p>BT81. X X X No Fix TSC is Not Affected by Warm Reset<br />
<a href="http://www.intel.com/content/dam/www/public/us/en/documents/specification-updates/xeon-e5-family-spec-update.pdf">Intel® Xeon® Processor E5 Family</a></p>
</blockquote>
<p>つまり、新 208.5 日問題は、<strong>最後に電源停止を行ってから208.5日程度経過した段階で、再起動をした際に前述の初期化処理において offset 計算が overflow することで顕在化します。</strong></p>
<p>旧 208.5 日問題とは異なり、<strong>稼働中の OS では発生しませんが、再起動時に突然ハング状態になるため、対策パッチをあてるか、tsc.c &amp; kernel.h を自前で修正してリビルドするか、運用プロセスを一時的に変更する必要があると思います。</strong>kexec時も同様の問題が起きるはずですので、ご注意ください。</p>
<p>記事に間違いや不明な点がありましたら、ご指摘下さい。</p>
<h3>参考URL</h3>
<ul>
<li><a href="https://access.redhat.com/site/solutions/433883">Red Hat : Systems with Intel® Xeon® Processor E5 hung after upgrade of Red Hat Enterprise Linux 6</a>  </li>
<li><a href="http://kernel.opensuse.org/cgit/kernel/commit/?id=9993bc635d01a6ee7f6b833b4ee65ce7c06350b1">OpenSUSE : sched/x86: Fix overflow in cyc2ns_offset</a></li>
</ul>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>
    <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52c240222104beab"></script>
    <!-- AddThis Button END -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'hisayosh'; // required: replace example with your forum shortname
            var disqus_identifier = '208days-problem';
            var disqus_url = 'http://hisayosh.github.io/posts/2013/12/208days-problem/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://twitter.com/hisayosh"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="http://www.linkedin.com/pub/hisayoshi-tamaki/35/26a/395"><i
                            class="icon-linkedin-sign icon-large"></i>linkedin
                    </a></li>
                    <li class="list-group-item"><a href="http://github.com/hisayosh"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>



            <li class="list-group-item"><a href="../../../../tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <li class="list-group-item tag-1">
                    <a href="../../../../tag/linux.html">
                        Linux
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/openid-connect.html">
                        OpenID Connect
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/bug.html">
                        Bug
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/tool.html">
                        Tool
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/oauth.html">
                        OAuth
                    </a>
                </li>
        </ul>
    </section>
</aside>        </div>
    </div>
</div>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../../theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'hisayosh'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
</body>
</html>