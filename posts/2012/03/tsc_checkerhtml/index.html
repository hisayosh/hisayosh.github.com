<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>tsc_checker.html</title>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-37369984-2', 'hisayosh.github.io');
        ga('send', 'pageview');
    </script>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

            <meta property="og:type" content="article"/>
            <meta property="og:title" content="tsc_checker.html"/>
            <meta property="og:url" content="../../../../posts/2012/03/tsc_checkerhtml/"/>
            <meta property="og:description" content="Title: tscchecker - 208.5 Slug: tscchecker Date: 2013-12-28 01:25 Category: Linux Tags: Linux, Tool Author: Hisayoshi Tamaki Summary: 208.5 [ 208.5 ](http://hisayosh.github.io/posts/2013/12/208days-problem/) TSC numeric overflow C GCC Inline Assembler Linux Kernel 208.5 [ ](http://hisayosh.github.io/posts/2013 ..."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../../theme/css/bootstrap.min.css" type="text/css"/>
    <link href="../../../../theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../theme/css/bootstrap-glyphicons.css" rel="stylesheet">
    <link href="../../../../theme/css/pygments.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="//code.jquery.com/jquery.min.js"></script>

        <link href="../../../../feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="hisayosh->blog ATOM Feed"/>
        <link href="../../../../feeds/all.rss.xml" type="application/atom+xml" rel="alternate"
              title="hisayosh->blog RSS Feed"/>

</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../../../.." class="navbar-brand">hisayosh->blog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="../../../../category/sso-identity.html">SSO, Identity</a>
                        </li>
                        <li >
                            <a href="../../../../category/linux.html">Linux</a>
                        </li>
                        <li class="active">
                            <a href="../../../../category/30.html">30</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="../../../../archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="../../../../posts/2012/03/tsc_checkerhtml/"
                       rel="bookmark"
                       title="Permalink to tsc_checker.html">
                        tsc_checker.html
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>Fri 02 March 2012
    </span>



</footer><!-- /.post-info -->                    </div>
                </div>
                

<p>Title: tsc<em>checker -  208.5 <br />
Slug: tsc</em>checker
Date: 2013-12-28 01:25
Category: Linux
Tags: Linux, Tool
Author: Hisayoshi Tamaki
Summary:   208.5                </p>

<pre><code>     [  208.5    ](http://hisayosh.github.io/posts/2013/12/208days-problem/)        TSC    numeric overflow                 C          GCC Inline Assembler     Linux Kernel     208.5                      [  ](http://hisayosh.github.io/posts/2013/12/208days-problem/)         **      208.5           uptime                                          TSC                                     **[*1](#1)
</code></pre>

<h3><em>*  *</em></h3>

<ul>
<li>TSC            </li>
<li>CPU               numeric overflow                </li>
</ul>

<h3><em>*    *</em></h3>

<ul>
<li>CPU    TSC  </li>
<li>CPU                SC  </li>
<li>pico sec order   64 bit    </li>
<li>64 bit       </li>
</ul>

<h2>### <em>*    *</em></h2>

<p>tsc<em>checker            tsc</em>checker       CPU                 2             </p>

<ol>
<li>Intel Xeon E5                 tsc_constant     TSC   CPU                                                  </li>
</ol>

<p><code>bash
$ sudo cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq
</code></p>

<ol>
<li>tsc_checker    </li>
</ol>

<p><code>
$ ./tsc_checker -f 2794000
TSC value        : 1476354219900
SC value         : 366
current value    : 540345644483400
threashold value : 18446744073709551615
</code></p>

<h2>### <em>*   *</em></h2>

<pre><code>             TSC     Inline Assembler                 rdtsc ( read time stamp counter )              32 bit   EDX register    32 bit   EAX register          uint32_t               uint64_t        32 bit    shift      bit         bit      OR             TSC
</code></pre>

<p>```c
uint64<em>t get</em>tsc(){</p>

<pre><code>uint64_t val;
uint32_t low, high;

asm volatile ("rdtsc" : "=a" (low), "=d" (high));
val = (uint64_t)low | ((uint64_t)high &lt;&lt; 32);

return val;
</code></pre>

<p>}
```</p>

<pre><code>SC ( SCale )               Linux Kernel                1000000 [*2](#2)      10 bit [*3](#3)     shift                                SC             tsc * scale   numeric overflow
</code></pre>

<p><code>c
    tsc = get_tsc();
    scale = (1000000 &lt;&lt; CYC2NS_SCALE_FACTOR) / cpu_khz;
    current = tsc * scale;
</code></p>

<pre><code>   Linux Kernel    tsc * scale                        numeric overflow             tsc_checker   [header file](https://github.com/hisayosh/tsc_checker/blob/master/tsc_checker.h)
</code></pre>

<p>```c
/* from linux kernel (/include/linux/kernel.h b/include/linux/kernel.h)
 * Multiplies an integer by a fraction, while avoiding unnecessary
 * overflow or loss of precision.
 */</p>

<h1>define mult_frac(x, numer, denom)(                        \</h1>

<p>{                                                          \
    typeof(x) quot = (x) / (denom);                        \
    typeof(x) rem  = (x) % (denom);                        \
    (quot * (numer)) + ((rem * (numer)) / (denom));        \
}                                                          \
)
```</p>

<p>tsc_checker                    91 <br />
<code>c
    current = mult_frac(tsc, scale, (1UL &lt;&lt; CYC2NS_SCALE_FACTOR));
</code></p>

<p><a name="1"></a>      Twitter                               </p>

<p><a name="2"></a> nano sec per micro sec  </p>

<p><a name="3"></a> scale factor  </p>


            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'hisayosh'; // required: replace example with your forum shortname
            var disqus_identifier = 'tsc_checkerhtml';
            var disqus_url = 'http://hisayosh.github.io/posts/2012/03/tsc_checkerhtml/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">
<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Social</h4></li>
                    <li class="list-group-item"><a href="http://twitter.com/hisayosh"><i
                            class="icon-twitter-sign icon-large"></i>twitter
                    </a></li>
                    <li class="list-group-item"><a href="http://www.linkedin.com/pub/hisayoshi-tamaki/35/26a/395"><i
                            class="icon-linkedin-sign icon-large"></i>linkedin
                    </a></li>
                    <li class="list-group-item"><a href="http://github.com/hisayosh"><i
                            class="icon-github-sign icon-large"></i>github
                    </a></li>



            <li class="list-group-item"><a href="../../../../tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <li class="list-group-item tag-1">
                    <a href="../../../../tag/linux.html">
                        Linux
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/oauth.html">
                        OAuth
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/tool.html">
                        Tool
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/bug.html">
                        Bug
                    </a>
                </li>
                <li class="list-group-item tag-4">
                    <a href="../../../../tag/openid-connect.html">
                        OpenID Connect
                    </a>
                </li>
        </ul>
    </section>
</aside>        </div>
    </div>
</div>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../../theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'hisayosh'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
</body>
</html>